<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Our Memories Together</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=Inter:wght@200;300;400;500;600&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="styles.css">

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

  <style>
    /* Upload-specific styles */
    .upload-section {
      position: fixed;
      bottom: 30px;
      right: 30px;
      z-index: 1000;
    }

    .upload-btn {
      background: rgba(255, 255, 255, .10);
      backdrop-filter: blur(20px);
      color: var(--text);
      border: 1px solid var(--line);
      padding: 16px 32px;
      border-radius: 50px;
      font-size: .9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all .3s;
      box-shadow: var(--shadow);
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.02em;
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      background: rgba(255, 255, 255, .14);
      border-color: rgba(255, 255, 255, .20);
      box-shadow: 0 24px 70px rgba(0, 0, 0, .65);
    }

    #photoInput {
      display: none;
    }

    .drawing-section {
      margin-top: 60px;
      width: 100%;
    }

    .drawing-section h2 {
      text-align: center;
      margin-bottom: 40px;
    }

    .canvas-container {
      display: flex;
      justify-content: center;
      margin-bottom: 30px;
    }

    #drawingCanvas {
      border: 1px solid var(--line);
      border-radius: var(--radius);
      cursor: crosshair;
      background: var(--panel);
      box-shadow: var(--shadow);
    }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
      padding: 25px;
      background: var(--panel);
      border-radius: var(--radius);
      border: 1px solid var(--line);
      box-shadow: var(--shadow);
      margin-bottom: 30px;
    }

    .controls label {
      font-weight: 400;
      color: var(--text);
      font-size: .9rem;
    }

    .controls input[type="color"],
    .controls input[type="range"] {
      cursor: pointer;
    }

    .controls button {
      background: rgba(255, 255, 255, .10);
      color: var(--text);
      border: 1px solid var(--line);
      padding: 10px 20px;
      border-radius: 12px;
      font-size: .9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all .3s;
    }

    .controls button:hover {
      background: rgba(255, 255, 255, .14);
      border-color: rgba(255, 255, 255, .20);
      transform: translateY(-1px);
    }

    .controls button.danger {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.3);
    }

    .controls button.danger:hover {
      background: rgba(239, 68, 68, 0.25);
      border-color: rgba(239, 68, 68, 0.5);
    }

    .no-photos {
      text-align: center;
      padding: 90px 20px;
      color: var(--muted);
      font-size: 1.05rem;
      letter-spacing: .12em;
      text-transform: uppercase;
    }

    /* accessibility */
    @media (prefers-reduced-motion: reduce) {
      .scroll-indicator {
        animation: none;
      }

      .photo-item {
        transition: none;
      }

      .photo-item img {
        transition: none;
      }
    }

    /* mobile */
    @media (max-width: 768px) {
      .container {
        padding: 40px 16px;
      }

      .photos-gallery {
        gap: 56px;
        padding: 56px 0 100px;
      }

      #drawingCanvas {
        max-width: 100%;
      }

      .upload-section {
        bottom: 20px;
        right: 20px;
      }
    }
  </style>
</head>

<body>
  <div class="container" id="mainContent">
    <!-- Hero Section -->
    <div class="hero-section">
      <h1>Our Memories Together</h1>
      <div class="scroll-indicator">â†“ SCROLL â†“</div>
    </div>

    <!-- Photos Gallery -->
    <div class="photos-gallery" id="photosGallery">
      <!-- Photos will be inserted here -->
    </div>

    <!-- Upload Button -->
    <div class="upload-section">
      <input type="file" id="photoInput" accept="image/*" multiple>
      <button class="upload-btn" onclick="document.getElementById('photoInput').click()">ðŸ“¸ Add Photos</button>
    </div>

    <!-- Drawing Section -->
    <div class="drawing-section">
      <h2>Express What's in Your Heart</h2>

      <div class="controls">
        <label for="colorPicker">Color:</label>
        <input type="color" id="colorPicker" value="#ffffff">

        <label for="brushSize">Brush Size:</label>
        <input type="range" id="brushSize" min="1" max="50" value="5">
        <span id="sizeDisplay">5px</span>

        <button id="clearBtn" class="danger">Clear Canvas</button>
        <button id="saveBtn">Save Drawing</button>
        <button id="eraserBtn">Eraser</button>
      </div>

      <div class="canvas-container">
        <canvas id="drawingCanvas" width="800" height="600"></canvas>
      </div>
    </div>
  </div>

  <script>

    // Canvas Setup
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');
    let isDrawing = false;
    let currentColor = '#ffffff';
    let brushSize = 5;
    let isEraser = false;

    /**
     * Start drawing on the canvas when mouse is pressed.
     * @param {MouseEvent} e - Mouse event object
     */
    function startDrawing(e) {
      isDrawing = true;
      draw(e);
    }

    /**
     * Stop drawing on the canvas when mouse is released or mouse leaves canvas.
     */
    function stopDrawing() {
      isDrawing = false;
      ctx.beginPath();
    }

    /**
     * Draw on the canvas based on mouse or touch position.
     * @param {MouseEvent|TouchEvent} e - Event object
     */
    function draw(e) {
      if (!isDrawing) return;

      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;

      ctx.lineWidth = brushSize;
      ctx.lineCap = 'round';
      ctx.strokeStyle = isEraser ? '#ffffff' : currentColor;

      ctx.lineTo(x, y);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
    }

    // Event Listeners for Drawing
    canvas.addEventListener('mousedown', startDrawing);
    canvas.addEventListener('mouseup', stopDrawing);
    canvas.addEventListener('mousemove', draw);
    canvas.addEventListener('mouseout', stopDrawing);

    // Touch support for mobile
    canvas.addEventListener('touchstart', (e) => {
      /**
       * Handle touch start event for drawing on mobile devices.
       * @param {TouchEvent} e - Touch event object
       */
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousedown', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchmove', (e) => {
      /**
       * Handle touch move event for drawing on mobile devices.
       * @param {TouchEvent} e - Touch event object
       */
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent('mousemove', {
        clientX: touch.clientX,
        clientY: touch.clientY
      });
      canvas.dispatchEvent(mouseEvent);
    });

    canvas.addEventListener('touchend', (e) => {
      /**
       * Handle touch end event for drawing on mobile devices.
       * @param {TouchEvent} e - Touch event object
       */
      e.preventDefault();
      const mouseEvent = new MouseEvent('mouseup', {});
      canvas.dispatchEvent(mouseEvent);
    });

    // Color Picker
    document.getElementById('colorPicker').addEventListener('change', (e) => {
      /**
       * Change the drawing color based on color picker selection.
       * @param {Event} e - Change event object
       */
      currentColor = e.target.value;
      isEraser = false;
    });

    // Brush Size
    document.getElementById('brushSize').addEventListener('input', (e) => {
      /**
       * Change the brush size for drawing.
       * @param {Event} e - Input event object
       */
      brushSize = e.target.value;
      document.getElementById('sizeDisplay').textContent = brushSize + 'px';
    });

    // Clear Canvas
    document.getElementById('clearBtn').addEventListener('click', () => {
      /**
       * Clear the entire canvas after user confirmation.
       */
      if (confirm('Are you sure you want to clear the canvas?')) {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
    });

    // Eraser
    document.getElementById('eraserBtn').addEventListener('click', () => {
      /**
       * Toggle eraser mode for drawing.
       */
      isEraser = !isEraser;
      const btn = document.getElementById('eraserBtn');
      btn.style.background = isEraser ? 'rgba(251, 191, 36, 0.4)' : 'rgba(139, 92, 246, 0.3)';
      btn.textContent = isEraser ? 'Drawing Mode' : 'Eraser';
    });

    // Save Drawing
    document.getElementById('saveBtn').addEventListener('click', () => {
      /**
       * Save the current canvas drawing as a PNG file.
       */
      const link = document.createElement('a');
      link.download = 'my-message.png';
      link.href = canvas.toDataURL();
      link.click();
    });

    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDs9_ezT2OqHJLh9VGasZeEU1fz7-LWzBQ",
      authDomain: "hehe-cbeb5.firebaseapp.com",
      databaseURL: "https://hehe-cbeb5-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "hehe-cbeb5",
      storageBucket: "hehe-cbeb5.firebasestorage.app",
      messagingSenderId: "350333356990",
      appId: "1:350333356990:web:862b0004e090689b33c7ef"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    // Sign in anonymously to Firebase (server handles authentication)
    firebase.auth().signInAnonymously()
      .catch((error) => {
        console.error('Firebase auth failed:', error);
      });

    // Photo Upload Handling with Security (Simplified - No Storage needed)
    const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5MB
    const ALLOWED_TYPES = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp'];

    document.getElementById('photoInput').addEventListener('change', async (e) => {
      const files = e.target.files;

      // Validate user is authenticated
      const user = firebase.auth().currentUser;
      if (!user) {
        alert('Authentication error. Please refresh and try again.');
        return;
      }

      for (let file of files) {
        // Validate file type
        if (!ALLOWED_TYPES.includes(file.type)) {
          alert(`Invalid file type: ${file.name}. Only images allowed.`);
          continue;
        }

        // Validate file size
        if (file.size > MAX_FILE_SIZE) {
          alert(`File too large: ${file.name}. Max size is 5MB.`);
          continue;
        }

        try {
          // Read file as data URL
          const reader = new FileReader();

          reader.onload = async (event) => {
            const dataURL = event.target.result;
            const timestamp = Date.now();

            // Save directly to Firebase Database (no Storage needed)
            const photoRef = database.ref('photos').push();
            await photoRef.set({
              url: dataURL,
              timestamp: timestamp,
              size: file.size,
              type: file.type,
              name: file.name
            });

            // Display photo
            displayPhoto(dataURL);
          };

          reader.readAsDataURL(file);

        } catch (error) {
          console.error('Upload error:', error);
          alert(`Error uploading ${file.name}: ${error.message}`);
        }
      }

      // Clear input
      e.target.value = '';
    });

    function displayPhoto(photoUrl) {
      const photosGallery = document.getElementById('photosGallery');
      const photoItem = document.createElement('div');
      photoItem.className = 'photo-item';

      const img = document.createElement('img');
      img.src = photoUrl;
      img.alt = 'Memory';

      photoItem.appendChild(img);
      photosGallery.appendChild(photoItem);

      setTimeout(() => checkScrollAnimations(), 100);
    }

    // Load existing photos from Firebase
    async function loadPhotos() {
      try {
        const photosSnapshot = await database.ref('photos').once('value');
        const photos = photosSnapshot.val();

        if (photos) {
          Object.values(photos).forEach(photo => {
            displayPhoto(photo.url);
          });
        }
      } catch (error) {
        console.error('Error loading photos:', error);
      }
    }

    // Call loadPhotos after authentication
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        loadPhotos();
      }
    });

    // Scroll Animation - check if photos are in viewport
    function checkScrollAnimations() {
      const photoItems = document.querySelectorAll('.photo-item');

      photoItems.forEach(item => {
        const rect = item.getBoundingClientRect();
        const isVisible = rect.top < window.innerHeight * 0.8;

        if (isVisible && !item.classList.contains('visible')) {
          item.classList.add('visible');
        }
      });
    }

    window.addEventListener('scroll', checkScrollAnimations);
    window.addEventListener('load', checkScrollAnimations);

    // Drag and Drop Support
    const photoUpload = document.getElementById('photoUpload');

    // Prevent default drag behaviors on the whole page
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      document.body.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    // Highlight drop area when dragging over it
    ['dragenter', 'dragover'].forEach(eventName => {
      photoUpload.addEventListener(eventName, () => {
        photoUpload.classList.add('drag-over');
      }, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
      photoUpload.addEventListener(eventName, () => {
        photoUpload.classList.remove('drag-over');
      }, false);
    });

    // Handle dropped files
    photoUpload.addEventListener('drop', (e) => {
      const dt = e.dataTransfer;
      const files = dt.files;
      handleFiles(files);
    }, false);

    // Handle pasted images (Cmd+V)
    document.addEventListener('paste', (e) => {
      const items = e.clipboardData.items;
      const files = [];

      for (let item of items) {
        if (item.type.startsWith('image/')) {
          files.push(item.getAsFile());
        }
      }

      if (files.length > 0) {
        handleFiles(files);
      }
    });

    // Unified file handling function
    function handleFiles(filesInput) {
      const photosSection = document.getElementById('photosSection');
      photosSection.innerHTML = '';
      photos = [];

      let loadedCount = 0;
      let totalFiles = 0;

      // Count valid image files
      for (let file of filesInput) {
        if (file && file.type.startsWith('image/')) {
          totalFiles++;
        }
      }

      if (totalFiles === 0) {
        photosSection.innerHTML = '<p style="color: #6c757d;">No valid images found. Please try again.</p>';
        return;
      }

      // Load all photos
      for (let file of filesInput) {
        if (file && file.type.startsWith('image/')) {
          const reader = new FileReader();

          reader.onload = (event) => {
            photos.push(event.target.result);
            loadedCount++;

            // When all photos are loaded, create containers
            if (loadedCount === totalFiles) {
              createPhotoContainers();
            }
          };

          reader.readAsDataURL(file);
        }
      }
    }

    // Initialize canvas background
    ctx.fillStyle = 'rgba(255, 255, 255, 0.05)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);
  </script>
</body>

</html>